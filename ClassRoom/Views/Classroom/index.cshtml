@{
    ViewData["Title"] = "Homework Tracker";
}

<div class="container mt-3">
    <div class="mb-3">
        <button id="resetButton" class="btn btn-danger">Reset All</button>
        <a asp-controller="Student" asp-action="Manage" class="btn btn-primary ms-2">Edit Students</a>
    </div>
    

    <div class="row" id="studentsContainer">
        <div class="col-12 text-center" id="loadingMessage">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading student list...</p>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
            initializeApp();
        });

        function initializeApp() {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/classroomHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            function refreshStudentUI(students) {
                $("#loadingMessage").remove();
                const container = $("#studentsContainer");
                container.empty();

                if (students.length === 0) {
                    container.html('<div class="col-12 text-center text-muted">No students found</div>');
                    return;
                }

                students.forEach((name, index) => {
                    container.append(`
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5 class="card-title">${name}</h5>
                                    <button class="btn btn-light student-button"
                                            data-student-id="${index}">
                                        Complete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `);
                });

                $(".student-button").off('click').on('click', function() {
                    const studentId = $(this).data("student-id");
                    connection.invoke("UpdateCompletionStatus", studentId, true)
                        .catch(err => console.error(err));
                });
            }

            connection.on("ReloadStudents", refreshStudentUI);
            connection.on("UpdateStatus", (studentId, isCompleted) => {
                const button = $(`button[data-student-id="${studentId}"]`);
                button.toggleClass("btn-light", !isCompleted)
                      .toggleClass("btn-success", isCompleted)
                      .text(isCompleted ? "Completed" : "Complete");
            });

            connection.on("ResetAll", () => {
                $(".student-button").removeClass("btn-success").addClass("btn-light").text("Complete");
            });

            connection.start()
                .then(() => connection.invoke("GetCurrentStudents"))
                .catch(err => {
                    console.error("Connection error:", err);
                    $("#loadingMessage p").text("Connection error. Refresh the page.");
                });

            $("#resetButton").click(() => {
                connection.invoke("ResetAllStatuses")
                    .catch(err => console.error(err));
            });
        }
    </script>
}
