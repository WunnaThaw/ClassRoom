@{
    ViewData["Title"] = "Homework Tracker";
}

<div class="container mt-3">
    <div class="mb-3">
        <button id="resetButton" class="btn btn-danger">Reset All</button>
        <a asp-controller="Student" asp-action="Manage" class="btn btn-primary ms-2">Edit Students</a>
    </div>
    

    <div class="row" id="studentsContainer">
        <div class="col-12 text-center" id="loadingMessage">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading student list...</p>
        </div>
    </div>

    <div class="mt-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <h4 class="mb-0">Group Chat</h4>

            <div class="d-flex align-items-center">
                <input type="text" id="usernameInput" class="form-control me-2" style="max-width: 180px;" placeholder="Your name" />

                <select id="avatarStyleSelect" class="form-select" style="max-width: 140px;">
                    <option value="thumbs">Thumbs</option>
                    <option value="bottts" selected>Bottts</option>
                    <option value="adventurer">Adventurer</option>
                </select>
            </div>
        </div>


        <div id="chatBox" class="border p-3" style="height: 250px; overflow-y: auto; background-color: #f8f9fa;"></div>
        <div class="input-group mb-2">
            <textarea id="chatInput" class="form-control" rows="3" placeholder="Type your message..."></textarea>
            <button id="sendChat" class="btn btn-primary ms-2">Send</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
            initializeApp();
        });

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function initializeApp() {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/classroomHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            function refreshStudentUI(students) {
                $("#loadingMessage").remove();
                const container = $("#studentsContainer");
                container.empty();

                if (students.length === 0) {
                    container.html('<div class="col-12 text-center text-muted">No students found</div>');
                    return;
                }

                students.forEach((student, index) => {
                    container.append(`
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5 class="card-title">${student.name}</h5>
                                    <button class="btn ${student.isCompleted ? "btn-success" : "btn-light"} student-button"
                                            data-student-id="${student.id}">
                                        ${student.isCompleted ? "Completed" : "Complete"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `);
                });


                $(".student-button").off('click').on('click', function () {
                    const studentId = $(this).data("student-id");
                    connection.invoke("UpdateCompletionStatus", studentId, true)
                        .catch(err => console.error("Update error:", err));
                });
            }

            connection.on("ReloadStudents", (students) => {
                refreshStudentUI(students);
            });

            connection.on("UpdateStatus", (studentId, isCompleted) => {
                const button = $(`button[data-student-id="${studentId}"]`);
                button.toggleClass("btn-light", !isCompleted)
                        .toggleClass("btn-success", isCompleted)
                        .text(isCompleted ? "Completed" : "Complete");
            });

            connection.on("ResetAll", () => {
                $(".student-button").removeClass("btn-success").addClass("btn-light").text("Complete");
            });

            function getRandomStyle() {
                const styles = ["thumbs", "bottts", "adventurer"];
                const index = Math.floor(Math.random() * styles.length);
                return styles[index];
            }

             connection.on("ReceiveMessage", (sender, message) => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const safeMessage = escapeHtml(message).replace(/\n/g, "<br>");

                let senderId = sender;
                let avatarStyle = "thumbs";

                // If anonymous → use random style + id
                if (sender.toLowerCase() === "anonymous") {
                    senderId = sender + Math.floor(Math.random() * 100000);
                    const styles = ["thumbs", "bottts", "adventurer"];
                    avatarStyle = styles[Math.floor(Math.random() * styles.length)];
                } else {
                    // Else → use selected style
                    avatarStyle = $("#avatarStyleSelect").val();
                }

                const avatarUrl = `https://api.dicebear.com/8.x/${avatarStyle}/svg?seed=${encodeURIComponent(senderId)}`;

                const chatBox = $("#chatBox");
                chatBox.append(`
                    <div class="d-flex mb-3">
                        <img src="${avatarUrl}" alt="${sender}" class="me-2"
                             style="width: 40px; height: 40px; border-radius: 50%;" />
                        <div class="flex-grow-1 p-2 rounded border bg-white shadow-sm">
                            <div class="d-flex align-items-center mb-1">
                                <strong>${sender}:</strong>
                                <span class="text-muted ms-2" style="font-size: 0.85em;">${timeStr}</span>
                            </div>
                            <div>${safeMessage}</div>
                        </div>
                    </div>
                `);

                chatBox.scrollTop(chatBox[0].scrollHeight);
            });




            $("#sendChat").click(() => {
                const message = $("#chatInput").val();
                const sender = $("#usernameInput").val().trim() || "Anonymous";

                if (message.trim() !== "") {
                    connection.invoke("SendMessage", sender, message)
                        .catch(err => console.error(err));
                    $("#chatInput").val("");
                }
            });


            connection.start()
                .then(() => connection.invoke("GetCurrentStudents"))
                .catch(err => {
                    console.error("Connection error:", err);
                    $("#loadingMessage p").text("Connection error. Refresh the page.");
                });

            $("#resetButton").click(() => {
                connection.invoke("ResetAllStatuses")
                    .catch(err => console.error(err));
            });
        }
    </script>
}
